<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<meta name="google-adsense-account" content="ca-pub-9382191250873184">
<meta name="theme-color" content="#61D6C2" />

<title>LocalFlow — 당첨 확인 & 재고 & 후기</title>

<!-- SEO -->
<meta name="description" content="LocalFlow 당첨 여부 조회, 상품 재고 확인, 당첨자 후기 모음  LocalFlow by Stance."/>
<meta name="keywords" content="LocalFlow, 로컬플로우, 로컬, 지역, 순환경제, 충주, 시민참여, 먹고싶니" />
<meta name="theme-color" content="#61D6C2" />
<link rel="canonical" href="https://localflow.info/winner.html" />

<!-- Open Graph -->
<meta property="og:title" content="LocalFlow — Circulation for 충주" />
<meta property="og:description" content="‘뭐 먹고 싶니?’ 한마디가 지역을 움직입니다. LocalFlow by Stance." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://localflow.info/winner.html" />
<meta property="og:image" content="https://localflow.info/og-cover.png" />

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2361D6C2'/%3E%3Cpath d='M18 36c8 10 20 10 28 0' fill='none' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3Cpath d='M14 26c4 6 10 9 18 9s14-3 18-9' fill='none' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E" />

<!-- StyleSheet -->
<link rel="stylesheet" href="./css/header.css" />
<link rel="stylesheet" href="./css/winner.css" />

</head>
  
<body>

<header>
  <div class="wrap nav">
    <div class="brand">
      <div class="logo">LF</div>
      <div>LocalFlow <small class="muted">— 당첨 확인</small></div>
      <span class="badge">beta</span>
    </div>
    <a class="pill" href="/" title="메인으로">← LocalFlow</a>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <span class="pill">주간 순환 프로젝트</span>
    <h1>내가 당첨됐나요?</h1>
    <p class="muted" style="margin:0">이 페이지에서 <b>응모 여부/당첨 여부</b>를 확인하고, <b>상품 재고</b>와 <b>당첨 후기</b>를 볼 수 있습니다.</p>
  </section>

  <!-- 검색 + 필터 + 새로고침 -->
  <div class="grid" style="grid-template-columns:1fr auto auto;gap:10px;margin-top:10px">
    <input id="listSearch" type="search" placeholder="이메일/닉네임/메모 검색 (부분 일치)">
    <select id="listFilter" aria-label="필터">
      <option value="">전체</option>
      <option value="win">당첨자만</option>
      <option value="nowin">미당첨만</option>
    </select>
    <button id="btnReset" class="btn">초기화</button>
  </div>
  
  <div class="hr"></div>
  
  <!-- 테이블 -->
  <div style="overflow:auto">
    <table class="table" aria-label="응모자 목록">
      <thead>
        <tr>
          <th style="min-width:220px">이메일</th>
          <th style="min-width:140px">닉네임</th>
          <th style="min-width:120px">응모일</th>
          <th style="min-width:120px">상태</th>
        </tr>
      </thead>
      <tbody id="applTbody">
        <tr><td colspan="4" class="muted">불러오는 중…</td></tr>
      </tbody>
    </table>
  </div>
  
  <!-- 페이저 -->
  <div id="applPager" class="pager">
    <button id="btnPrev" class="btn" disabled>이전</button>
    <div id="applInfo" class="muted">-</div>
    <button id="btnNext" class="btn" disabled>다음</button>
  </div>

  <!-- 2. 상품 종류 및 재고 -->
  <section style="margin-top:12px">
    <h2>2) 상품 종류 및 재고</h2>
    <div id="prizeGrid" class="grid cols-3">
      <!-- JS 렌더 -->
    </div>
  </section>

  <!-- 3. 당첨자 후기 -->
  <section style="margin-top:12px">
    <h2>3) 당첨자 후기</h2>
    <div id="revGrid" class="grid cols-4">
      <!-- JS 렌더 -->
    </div>
    <p class="muted" style="margin-top:6px">
      ※ 업로드는 당첨자 개별 이메일로 전달된 전용 업로드 URL에서 진행합니다. (스팸/도용 방지)
    </p>
  </section>
</main>

<!-- 후기 미리보기 모달 -->
<div id="modal" class="modal" aria-hidden="true" role="dialog" aria-label="후기 이미지 확대">
  <div class="dialog">
    <header>
      <strong id="mTitle">후기 미리보기</strong>
      <button id="mClose" class="pill" aria-label="닫기">닫기</button>
    </header>
    <div class="content">
      <img id="mImg" src="" alt="후기 이미지">
      <div style="padding:10px;border-top:1px solid var(--line)">
        <div id="mMeta" class="muted" style="font-size:12px"></div>
        <div id="mText" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== API Endpoints (동일 오리진 권장) =====
   응모자/당첨 조회     GET  /event/applicants.json
                       -> [{email,nick,date,win(boolean)}]
   단건 확인           GET  /event/check?email=...
                       -> {exists:true|false, win:true|false, round:"2025-W45", prize:"치킨 쿠폰"?}
   상품/재고           GET  /data/prizes.json
                       -> {round:"...", items:[{id,name,stock,img}]}
   후기 리스트         GET  /data/reviews.json
                       -> [{id,img,thumb?,title,text,by,date}]  (thumb 없으면 img 사용)
*/
const API = {
  applicants: "https://mrdindoin.ddns.net/data/applicants.json",
  check:      "https://mrdindoin.ddns.net/event/check",
  prizes:     "https://mrdindoin.ddns.net/data/prizes.json",
  reviews:    "https://mrdindoin.ddns.net/data/reviews.json"
};

const $ = s=>document.querySelector(s);

/* ---------- 1) 응모 여부 조회 ---------- */

const API_APPLICANTS = "https://mrdindoin.ddns.net/winner/applicants"; // 동일 오리진 프록시/서버 기준

const applTbody  = document.getElementById("applTbody");
const listSearch = document.getElementById("listSearch");
const listFilter = document.getElementById("listFilter");
const btnReset   = document.getElementById("btnReset");
const btnPrev    = document.getElementById("btnPrev");
const btnNext    = document.getElementById("btnNext");
const applInfo   = document.getElementById("applInfo");

const applState = { page: 1, size: 20, q: "", f: "" };

function setLoading(){
  applTbody.innerHTML = `<tr><td colspan="4" class="muted">불러오는 중…</td></tr>`;
}

async function fetchApplicants(){
  setLoading();
  const params = new URLSearchParams({ page: applState.page, size: applState.size });
  if (applState.q) params.set("q", applState.q);
  if (applState.f) params.set("f", applState.f);

  const url = `${API_APPLICANTS}?${params.toString()}`;
  try{
    const r = await fetch(url, { cache:"no-store" });
    const ct = r.headers.get("content-type") || "";
    const raw = await r.text();        // ← 우선 문자열로 받기
    // 디버깅 로그
    console.log("[APPLICANTS]", r.status, ct, raw.slice(0,200));

    if (!r.ok) throw new Error(r.status);

    let j;
    if (ct.includes("application/json")) {
      j = JSON.parse(raw);
    } else {
      // JSON이 아니면 상세 메시지로 에러 처리
      throw new Error(`Not JSON: ${raw.slice(0,80)}`);
    }
    renderApplicants(j);
  }catch(e){
    applTbody.innerHTML =
      `<tr><td colspan="4" class="muted">목록을 불러오지 못했습니다 ${e?.message?`(${e.message})`:""}.</td></tr>`;
    applInfo.textContent = "-";
    btnPrev.disabled = btnNext.disabled = true;
  }
}

function renderApplicants(j){
  // rows
  const rows = (j.items||[]).map(a=>{
    const st = a.win ? `<span class="status-pill win">당첨</span>`
                     : `<span class="status-pill ok">응모</span>`;
    return `<tr>
      <td>${escapeHtml(a.email||"")}</td>
      <td>${escapeHtml(a.nick||"-")}</td>
      <td>${escapeHtml(a.date||"-")}</td>
      <td>${st}</td>
    </tr>`;
  }).join("");

  applTbody.innerHTML = rows || `<tr><td colspan="4" class="muted">검색 결과가 없습니다.</td></tr>`;

  // pager
  applInfo.textContent = `총 ${j.total?.toLocaleString?.()||0}명 · ${j.page}/${j.pages||1} 페이지`;
  btnPrev.disabled = (j.page <= 1);
  btnNext.disabled = !j.has_next;
  btnPrev.onclick  = ()=>{ if(j.page>1){ applState.page = j.page-1; fetchApplicants(); window.scrollTo({top:0,behavior:"smooth"});} };
  btnNext.onclick  = ()=>{ if(j.has_next){ applState.page = j.page+1; fetchApplicants(); window.scrollTo({top:0,behavior:"smooth"});} };
}

// 검색/필터/리셋
if (listSearch) listSearch.addEventListener("input", debounce(()=>{
  applState.q = (listSearch.value||"").trim();
  applState.page = 1;
  fetchApplicants();
}, 250));

if (listFilter) listFilter.addEventListener("change", ()=>{
  applState.f = listFilter.value || "";
  applState.page = 1;
  fetchApplicants();
});

if (btnReset) btnReset.onclick = ()=>{
  if (listSearch) listSearch.value = "";
  if (listFilter) listFilter.value = "";
  applState.q = ""; applState.f = ""; applState.page = 1;
  fetchApplicants();
};

// 유틸 (escapeHtml / debounce) — 기존에 있으면 중복 정의 생략
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

// 최초 로드
fetchApplicants();

  

/* ---------- 2) 상품 종류 및 재고 ---------- */
const prizeGrid = $("#prizeGrid");
async function loadPrizes(){
  prizeGrid.innerHTML = "";
  try{
    const r = await fetch(API.prizes, {cache:"no-store"});
    const j = r.ok ? await r.json() : {items:[]};
    (j.items||[]).forEach(p=>{
      const img = p.img ? `<img src="${encodeURI(p.img)}" loading="lazy" alt="${escapeHtml(p.name)}">`
                        : `<span class="muted">No Image</span>`;
      prizeGrid.insertAdjacentHTML("beforeend", `
        <article class="prize">
          <div class="thumb">${img}</div>
          <div class="meta">
            <div><strong>${escapeHtml(p.name)}</strong><div class="stock">재고 <strong>${p.stock??"-"}</strong></div></div>
            ${p.brand?`<span class="pill">${escapeHtml(p.brand)}</span>`:""}
          </div>
        </article>
      `);
    });
  }catch(e){
    prizeGrid.innerHTML = `<div class="card muted">상품 정보를 불러오지 못했습니다.</div>`;
  }
}

/* ---------- 3) 당첨자 후기 ---------- */
const revGrid = $("#revGrid");
const modal = $("#modal"), mImg=$("#mImg"), mTitle=$("#mTitle"), mText=$("#mText"), mMeta=$("#mMeta");
$("#mClose").onclick = ()=> modal.classList.remove("show");
modal.addEventListener("click", e=>{ if(e.target===modal) modal.classList.remove("show"); });

async function loadReviews(){
  revGrid.innerHTML = "";
  try{
    const r = await fetch(API.reviews, {cache:"no-store"});
    const arr = r.ok ? await r.json() : [];
    if(!arr.length){
      revGrid.innerHTML = `<div class="card muted">아직 후기가 없습니다.</div>`;
      return;
    }
    arr.forEach(v=>{
      const t = v.thumb || v.img;
      revGrid.insertAdjacentHTML("beforeend", `
        <article class="rev">
          <div class="thumb">
            <img src="${encodeURI(t)}" loading="lazy" alt="${escapeHtml(v.title||'후기 이미지')}"
                 onclick="openReview('${encodeURIComponent(v.img)}','${escapeHtmlJS(v.title||"후기")}','${escapeHtmlJS(v.by||"-")}','${escapeHtmlJS(v.date||"")}','${escapeHtmlJS(v.text||"")}')">
          </div>
          <div class="body">
            <div class="meta"><span>${escapeHtml(v.title||"후기")}</span><span>${escapeHtml(v.date||"")}</span></div>
            <div class="muted" style="font-size:12px">${escapeHtml(v.by||"")}</div>
          </div>
        </article>
      `);
    });
  }catch(e){
    revGrid.innerHTML = `<div class="card muted">후기를 불러오지 못했습니다.</div>`;
  }
}

window.openReview = (imgUrlEnc, title, by, date, text)=>{
  mImg.src = decodeURIComponent(imgUrlEnc);
  mTitle.textContent = title;
  mMeta.textContent = `${by||""} ${date?(" · "+date):""}`;
  mText.textContent = text||"";
  modal.classList.add("show");
};

/* ---------- utils ---------- */
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function escapeHtmlJS(s){ return escapeHtml(s).replace(/\n/g," "); }
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ---------- init ---------- */

loadPrizes();
loadReviews();
</script>

</body>
</html>
