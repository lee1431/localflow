<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>LocalFlow ì—…ì£¼ìš© ì¿ í° ìŠ¤ìºë„ˆ</title>
  <style>
    :root{
      --bg:#050711;
      --panel:#0f172a;
      --accent:#61d6c2;
      --danger:#f97373;
      --ok:#4ade80;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2937;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(circle at top,#111827,#020617);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .wrap{
      width:100%;
      max-width:480px;
      background:rgba(15,23,42,.94);
      border-radius:20px;
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 45px rgba(0,0,0,.7);
      padding:18px 18px 20px;
    }
    h1{
      margin:0 0 4px;
      font-size:20px;
    }
    .sub{
      margin:0 0 14px;
      font-size:12px;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border-radius:999px;
      background:rgba(15,118,110,.18);
      border:1px solid rgba(45,212,191,.4);
      font-size:11px;
      margin-bottom:8px;
    }
    .badge-dot{
      width:6px;height:6px;border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 8px #22c55e;
    }
    #qr-reader{
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      background:#020617;
      margin-bottom:12px;
    }
    #status{
      border-radius:14px;
      padding:10px 12px;
      background:rgba(15,23,42,0.9);
      border:1px solid var(--line);
      font-size:13px;
      min-height:42px;
      display:flex;
      flex-direction:column;
      gap:4px;
      white-space:pre-line;
    }
    #status strong{
      font-weight:600;
    }
    #status.ok strong{color:var(--ok);}
    #status.err strong{color:var(--danger);}
    .field-row{
      font-size:12px;
      color:var(--muted);
    }
    .field-row span{
      color:var(--text);
      font-weight:500;
    }
    .btn-row{
      margin-top:10px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    button{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      color:var(--text);
      font-size:12px;
      padding:7px 14px;
    }
    button.primary{
      border-color:transparent;
      background:linear-gradient(135deg,#22c55e,#4ade80);
      color:#022c22;
      font-weight:600;
    }
  </style>

  <!-- QR ìŠ¤ìºë„ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="badge">
      <div class="badge-dot"></div>
      LocalFlow ì—…ì£¼ìš© ì¿ í° ìŠ¤ìºë„ˆ
    </div>
    <h1>QR ì¿ í° ìŠ¤ìº”</h1>
    <p class="sub">
      ë‹¹ì²¨ìê°€ ë³´ì—¬ì£¼ëŠ” QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´<br>
      ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ê°€ ìë™ìœ¼ë¡œ í™•ì¸ë©ë‹ˆë‹¤.
    </p>

    <div id="qr-reader"></div>

    <div id="status">
      <strong>ëŒ€ê¸° ì¤‘â€¦</strong>
      <span style="font-size:12px;color:var(--muted);">
        QR ì½”ë“œì— ì¹´ë©”ë¼ë¥¼ ê°€ì ¸ë‹¤ ëŒ€ë©´ ìë™ ì¸ì‹ë©ë‹ˆë‹¤.
      </span>
    </div>

    <div class="btn-row">
      <button id="btn-rescan">ë‹¤ì‹œ ìŠ¤ìº”</button>
    </div>
  </div>

<script>
  const statusBox = document.getElementById('status');
  const btnRescan = document.getElementById('btn-rescan');
  let qr = null;
  let isProcessing = false;

  function setStatus(mode, title, detail){
    statusBox.classList.remove('ok','err');
    if(mode) statusBox.classList.add(mode);
    statusBox.innerHTML = '';
    const s1 = document.createElement('strong');
    s1.textContent = title;
    statusBox.appendChild(s1);
    if(detail){
      const s2 = document.createElement('div');
      s2.className = 'field-row';
      s2.innerHTML = detail;
      statusBox.appendChild(s2);
    }
  }

  function extractToken(raw){
    try{
      const u = new URL(raw);

      // 1) ?token=... ìš°ì„ 
      const qsToken = u.searchParams.get('token');
      if(qsToken) return qsToken;

      // 2) /c/ABC123 íŒ¨í„´ì€ ë§ˆì§€ë§‰ path ì¡°ê° ì‚¬ìš©
      const segs = u.pathname.split('/').filter(Boolean);
      const last = segs[segs.length - 1];
      if(last) return last;
    }catch(e){
      // URL ì•„ë‹ˆë©´ ê·¸ëƒ¥ rawë¥¼ í† í°ìœ¼ë¡œ
    }
    return raw.trim();
  }

  async function sendTokenToServer(token){
    isProcessing = true;
    setStatus(null, 'ì„œë²„ í™•ì¸ ì¤‘â€¦', `<div>í† í°: <span>${token}</span></div>`);
    try{
      const res = await fetch('https://mrdindoin.ddns.net/upzoo/api/coupon/use', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      if(data.ok){
        const detail = `
          <div>ì—…ì²´: <span>${data.shop_name || data.shop_id || '-'}</span></div>
          <div>ê¸ˆì•¡: <span>${data.amount || '-'} ì›</span></div>
          <div>ì‚¬ìš©ì‹œê°: <span>${data.used_at || '-'}</span></div>
        `;
        setStatus('ok', 'âœ… ì¿ í° ì‚¬ìš© ì²˜ë¦¬ ì™„ë£Œ', detail);
      }else{
        const detail = `
          <div>ì‚¬ìœ : <span>${data.message || 'ì‚¬ìš© ë¶ˆê°€'}</span></div>
          ${data.used_at ? `<div>ì‚¬ìš©ì‹œê°: <span>${data.used_at}</span></div>` : ''}
        `;
        setStatus('err', 'â›” ì¿ í° ì‚¬ìš© ë¶ˆê°€', detail);
      }
    }catch(err){
      console.error(err);
      setStatus('err', 'ì„œë²„ í†µì‹  ì˜¤ë¥˜', '<div>ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>');
    }finally{
      isProcessing = false;
    }
  }

  async function stopScanner(){
    if(!qr) return;
    try{
      await qr.stop();
    }catch(e){
      console.warn('stop error (ë¬´ì‹œí•´ë„ ë¨):', e);
    }
    try{
      await qr.clear();
    }catch(e){
      console.warn('clear error (ë¬´ì‹œí•´ë„ ë¨):', e);
    }
    qr = null;
  }

  async function startScanner(){
    // ë‹¤ì‹œ ìŠ¤ìº” ì‹œ ìƒíƒœ ì´ˆê¸°í™”
    isProcessing = false;
    setStatus(null, 'ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘â€¦', '<div>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>');

    await stopScanner(); // í˜¹ì‹œ ë‚¨ì•„ìˆë˜ ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬

    qr = new Html5Qrcode("qr-reader");

    try{
      const devices = await Html5Qrcode.getCameras();
      if (!devices || !devices.length) {
        setStatus('err', 'ì¹´ë©”ë¼ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', '');
        return;
      }

      // ğŸ”¥ í›„ë°© ì¹´ë©”ë¼ ìš°ì„  ì„ íƒ
      let backCam =
        devices.find(d => (d.label || '').toLowerCase().includes('back')) ||
        devices.find(d => (d.label || '').toLowerCase().includes('rear')) ||
        devices.find(d => (d.label || '').includes('í›„ë©´')) ||
        devices[0];

      const config = { fps: 10, qrbox: { width: 240, height: 240 } };

      const onScanSuccess = (decodedText, decodedResult) => {
        if(isProcessing) return;
        const token = extractToken(decodedText);
        if(!token){
          setStatus('err', 'ì¸ì‹ ì‹¤íŒ¨', 'ìœ íš¨í•œ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        // í•œ ë²ˆ ì½ìœ¼ë©´ ë©ˆì¶”ê³  ì„œë²„ë¡œ ì „ì†¡
        stopScanner();
        sendTokenToServer(token);
      };

      const onScanError = (err) => {
        // í•„ìš”í•˜ë©´ ë””ë²„ê¹…ìš©
        // console.warn(err);
      };

      await qr.start(backCam.id, config, onScanSuccess, onScanError);
      setStatus(null, 'ëŒ€ê¸° ì¤‘â€¦', '<span>QR ì½”ë“œì— ì¹´ë©”ë¼ë¥¼ ê°€ì ¸ë‹¤ ëŒ€ë©´ ìë™ ì¸ì‹ë©ë‹ˆë‹¤.<br>(í›„ë©´ ì¹´ë©”ë¼ ì‚¬ìš©)</span>');
    }catch(err){
      console.error(err);
      setStatus('err', 'ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨', '<div>ë¸Œë¼ìš°ì € ê¶Œí•œ ë˜ëŠ” ë‹¤ë¥¸ ì•±ì—ì„œ ì¹´ë©”ë¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>');
      await stopScanner();
    }
  }

  btnRescan.addEventListener('click', () => {
    // ë‹¤ì‹œ ìŠ¤ìº” ë²„íŠ¼ ëˆ„ë¥´ë©´ ë‹¤ì‹œ startScanner
    startScanner();
  });

  // ì²« ì§„ì… ì‹œ ìë™ ì‹œì‘
  window.addEventListener('load', () => {
    startScanner();
  });
</script>


</body>
</html>
