<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="google-adsense-account" content="ca-pub-9382191250873184">
  <title>LocalFlow — Circulation for 충주</title>

  <!-- SEO -->
  <meta name="description" content="LocalFlow는 ‘뭐 먹고 싶니?’라는 한마디로 지역의 식욕 데이터를 모아 주간 순환 소비를 실행하는 시민 참여형 프로젝트입니다. LocalFlow by Stance." />
  <meta name="keywords" content="LocalFlow, 로컬플로우, 로컬, 지역, 순환경제, 충주, 시민참여, 먹고싶니" />
  <meta name="theme-color" content="#61D6C2" />
  <link rel="canonical" href="https://localflow.info/" />

  <!-- Open Graph -->
  <meta property="og:title" content="LocalFlow — Circulation for 충주" />
  <meta property="og:description" content="‘뭐 먹고 싶니?’ 한마디가 지역을 움직입니다. LocalFlow by Stance." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://localflow.info/" />
  <meta property="og:image" content="https://localflow.info/og-cover.png" />

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2361D6C2'/%3E%3Cpath d='M18 36c8 10 20 10 28 0' fill='none' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3Cpath d='M14 26c4 6 10 9 18 9s14-3 18-9' fill='none' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E" />

  <!-- AdSense (원하실 때 유지) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9382191250873184" crossorigin="anonymous"></script>

  <style>
    :root{
      --mint:#61D6C2; --cream:#FFF5E0; --ink:#22303A; --muted:#6B7A86; --line:#E9EEF2;
      --bg:#FBFCFD; --pill:#F2FAF8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Nanum Gothic",sans-serif;
      color:var(--ink); background:linear-gradient(180deg,var(--bg),#ffffff);
    }
    a{color:var(--ink); text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:0 20px}

    /* Header */
    header{position:sticky; top:0; left:0; right:0; backdrop-filter:saturate(1.2) blur(8px); background:#ffffffb8; border-bottom:1px solid var(--line); z-index:50}
    .nav{display:flex; align-items:center; justify-content:space-between; height:64px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700}
    .logo{width:28px; height:28px; border-radius:50%; background:var(--mint); display:inline-block}
    .brand small{font-weight:600; color:var(--muted)}
    .chip{padding:.4rem .7rem; border:1px solid var(--line); border-radius:999px; background:#fff; font-size:.85rem}

    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; z-index:40; }
    .overlay.show{ display:block; }

    /* Mobile menu */
    .hamb{width:40px; height:40px; border:1px solid var(--line); border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer}
    .hamb span{display:block; width:18px; height:2px; background:var(--ink); position:relative}
    .hamb span::before,.hamb span::after{content:""; position:absolute; left:0; width:18px; height:2px; background:var(--ink)}
    .hamb span::before{top:-6px} .hamb span::after{top:6px}
    .menu{display:none; gap:8px}
    .menu.show{display:flex}
    @media(min-width:860px){ .menu{display:flex} .hamb{display:none} }

    /* Hero */
    .hero{position:relative; padding:80px 0 52px; overflow:hidden; background:
      radial-gradient(1200px 400px at 50% -50%, var(--cream), transparent 60%);}
    .hero h1{font-size:clamp(28px,5vw,44px); line-height:1.1; margin:0 0 10px}
    .hero p{font-size:clamp(16px,2.5vw,18px); color:var(--muted); margin:0 0 22px}
    .hero .ask{margin-top:18px; display:flex; gap:10px; flex-wrap:wrap}
    .input{flex:1; min-width:240px; padding:14px 16px; border:1.5px solid var(--line); border-radius:14px; outline:none; font-size:16px; background:#fff}
    .btn{padding:14px 18px; border:none; border-radius:14px; background:var(--mint); color:#083a36; font-weight:700; cursor:pointer}
    .btn:active{transform:translateY(1px)}

    /* Floating words area */
    .cloud{position:relative; height:240px; margin-top:26px; border:1px dashed var(--line); border-radius:16px; background:var(--pill); overflow:hidden;}
    .word{
      position:absolute; font-weight:700; white-space:nowrap; pointer-events:none;
      filter:drop-shadow(0 1px 0 rgba(0,0,0,.06));
      animation: floatUp linear forwards;
      will-change: transform, opacity;
    }
    @keyframes floatUp{
      0%   { transform: translate3d(var(--dx,0), 20px, 0) scale(1); opacity: 0; }
      12%  { opacity: 1; }
      70%  { transform: translate3d(calc(var(--dx,0) * -1), -180px, 0) scale(1.02); opacity: 1; }
      100% { transform: translate3d(0, -260px, 0) scale(1.02); opacity: 0; }
    }

    /* Sections */
    section{padding:56px 0; border-top:1px solid var(--line); scroll-margin-top:72px;}
    h2{font-size:clamp(22px,4vw,28px); margin:0 0 14px}
    .grid{display:grid; grid-template-columns:1fr; gap:14px}
    .card{padding:18px; border:1px solid var(--line); border-radius:16px; background:#fff}
    .card h3{margin:0 0 6px; font-size:18px}
    .pill{display:inline-block; padding:.35rem .65rem; border-radius:999px; background:var(--pill); border:1px solid var(--line); font-size:.8rem}

    @media(min-width:860px){
      .grid.cols-3{grid-template-columns:repeat(3,1fr)}
      .grid.cols-2{grid-template-columns:repeat(2,1fr)}
      .hero{padding:110px 0 70px}
      .cloud{height:300px}
    }

    /* Mobile dropdown */
    .mobile-nav{ display:none; background:#fff; border-top:1px solid var(--line); }
    .mobile-nav.show{ display:block; }
    .mobile-nav a{
      display:block; padding:14px 16px; text-align:center;
      border-top:1px solid var(--line);
    }
    .mobile-nav a:hover{ background:#f6f7f9; }
    
    header{ position:sticky; top:0; backdrop-filter:saturate(1.2) blur(8px);
      background:#ffffffb8; border-bottom:1px solid var(--line); z-index:50; }

    /* Footer */
    footer{padding:40px 0; border-top:1px solid var(--line); background:#fff}
    .footline{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
    .muted{color:var(--muted)}


    .to-top{
      position:fixed; right:16px; bottom:16px;
      width:44px; height:44px; border-radius:999px;
      border:1px solid var(--line); background:#fff; color:var(--ink);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      cursor:pointer; opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:60;
    }
    .to-top.show{ opacity:1; pointer-events:auto; }
    .to-top:active{ transform:translateY(1px); }

    .notice-card{ display:grid; grid-template-columns:96px 1fr; gap:14px; align-items:start; }
    .notice-thumb{ width:96px; height:96px; border-radius:12px; object-fit:cover; border:1px solid var(--line); background:#fff; }
    .notice-meta{ font-size:.85rem; color:var(--muted); }
    .notice-title{ margin:0 0 6px; font-size:18px; font-weight:700; }
    .notice-body{ margin:6px 0 0; line-height:1.6; word-break:keep-all; }
    @media(max-width:859px){
      .notice-card{ grid-template-columns:1fr; }
      .notice-thumb{ width:100%; height:180px; }
    }

    /* === Notice Modal === */
    .notice-modal{position:fixed;inset:0;z-index:80;display:none;}
    .notice-modal.show{display:block;}
    .notice-modal .modal-backdrop{
      position:absolute;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(3px);
    }
    .notice-modal .modal-dialog{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      width:90%;max-width:520px;max-height:90vh;overflow:auto;
      background:#fff;border-radius:18px;padding:22px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .modal-img{width:100%;border-radius:12px;margin-bottom:16px;object-fit:cover;}
    .modal-title{margin:6px 0 12px;font-size:22px;font-weight:700;}
    .modal-body{line-height:1.65;white-space:pre-line;}
    .modal-meta{font-size:.85rem;color:var(--muted);margin-bottom:4px;}
    .modal-close{
      position:absolute;top:10px;right:14px;border:none;background:none;
      font-size:24px;cursor:pointer;color:#444;
    }
    @media(max-width:480px){
      .modal-dialog{padding:18px;}
      .modal-img{max-height:200px;object-fit:cover;}
    }
    
    #toast.show{ opacity:1; }
    
  </style>

  
</head>
  
<body>
  <!-- Header -->
  <header>
  <div class="wrap">
    <div class="nav" style="display:flex;align-items:center;justify-content:space-between;height:64px;">
      <div class="brand">
        <span class="logo"></span>
        <div>LocalFlow <small>by Stance</small></div>
      </div>
      <button id="menuBtn" aria-label="메뉴 열기" class="hamb" style="margin-left:12px">
        <span></span>
      </button>
    </div>

    <!-- 드롭다운 메뉴 -->
    <nav id="mobileMenu" class="mobile-nav" aria-label="Mobile Navigation">
      <a href="#concept">개념</a>
      <a href="#loop">작동방식</a>
      <a href="#values">가치</a>
      <a href="#roadmap">로드맵</a>
    </nav>
  </div>
</header>
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  
  <!-- Hero -->
  <section class="hero" aria-labelledby="hero-title">
    <div class="wrap">
      <span class="pill">시민 참여형 로컬 순환 프로젝트</span>
      <h1 id="hero-title">뭐 먹고 싶니? <br/>그 한마디가 지역을 움직입니다.</h1>
      <p>LocalFlow는 ‘먹고 싶은 것’을 데이터로 모아 주간 랭킹을 만들고, 실제 소비로 연결합니다.</p>

      <form class="ask" onsubmit="return addWord(event)" aria-label="먹고 싶은 음식 입력">
        <input class="input" id="foodInput" name="food" maxlength="24" autocomplete="off" placeholder="예: 치킨, 라멘, 곱창, 탕수육…" aria-label="먹고 싶은 음식" />
        <button class="btn" type="submit">보내기</button>
        <a class="chip" href="#loop" aria-label="작동 방식 자세히">도움말</a>
      </form>

      <div class="cloud" id="cloud" aria-hidden="true"></div>
      <noscript><p class="muted" style="margin-top:10px">브라우저에서 자바스크립트가 꺼져 있습니다. 단어 구름 애니메이션은 표시되지 않습니다.</p></noscript>
    </div>
  </section>

  <section id="email-section" class="wrap" style="margin-top:40px;text-align:center">
    <input id="emailInput" type="email" placeholder="이메일을 입력하세요"
           style="padding:12px 14px;border:1px solid #ccc;border-radius:10px;width:250px;font-size:15px;">
    <button id="emailSubmit"
            style="background:#61D6C2;border:none;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer;">
      확인
    </button>
    <div id="emailDisplay" style="margin-top:10px;display:none;">
      <button id="emailBtn"
              style="background:#fff;border:1px solid #ccc;border-radius:999px;padding:8px 14px;cursor:pointer;">
      </button>
    </div>
  </section>

  <!-- Concept -->
  <section id="concept">
    <div class="wrap">
      <h2>LocalFlow — 개념</h2>
      <div class="grid cols-3">
        <div class="card">
          <h3>참여의 단순화</h3>
          <p>로그인 없이, 한 번의 입력. 초저항 인터페이스로 누구나 참여.</p>
        </div>
        <div class="card">
          <h3>소비의 순환화</h3>
          <p>주간 랭킹 1등 메뉴를 매주 <strong>목요일</strong> 선정합니다.</p>
        </div>
        <div class="card">
          <h3>욕구의 시각화</h3>
          <p>전달된 내용은 필터링 후 노출됩니다. AI 필터링으로 <strong>24시간 이후 확인</strong> 가능합니다.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Loop -->
  <section id="loop">
    <div class="wrap">
      <h2>주간 루프 — 어떻게 작동하나요?</h2>
      <div class="grid cols-4" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px;">
        <div class="card"><span class="pill">① 참여</span><h3>입력</h3><p>“뭐 먹고 싶니?”에 답하면 데이터로 저장됩니다.</p></div>
        <div class="card"><span class="pill">② 집계</span><h3>랭킹</h3><p>일주일 단위로 그룹화하여 상위 메뉴를 산출합니다.</p></div>
        <div class="card"><span class="pill">③ 실행</span><h3>구매</h3><p>매주 정해진 금액만큼의 인원을 추첨, 지역상품권 증정.</p></div>
        <div class="card"><span class="pill">④ 공개</span><h3>공유</h3><p>웹/카드뉴스로 결과를 발표하고 다음 주로 이어갑니다.</p></div>
      </div>
    </div>
  </section>

<!-- Notices -->
<section id="notices">
  <div class="wrap">
    <h2>공지</h2>
    <div id="noticeSkeleton" class="grid cols-2" aria-hidden="true">
      <div class="card"><div class="muted">불러오는 중…</div></div>
      <div class="card"><div class="muted">불러오는 중…</div></div>
    </div>
    <div id="noticeFeed" class="grid cols-2"></div>
    <div style="margin-top:12px">
      <button id="noticeMore" class="btn" style="display:none">더보기</button>
    </div>
  </div>
</section>


  <!-- Roadmap -->
  <section id="roadmap">
    <div class="wrap">
      <h2>로드맵</h2>
      <div class="grid cols-3">
        <div class="card"><h3>Phase 1 — 2025.11</h3><p>MVP 론칭: 입력/랭킹/결과 공개. 도메인 연결.</p></div>
        <div class="card"><h3>Phase 2 — 2025.12</h3><p>관리자 추첨/통계 카드뉴스 자동화. 도시별 서브도메인.</p></div>
        <div class="card"><h3>Phase 3 — 2026.01~</h3><p>로컬 가맹 연계 쿠폰, 데이터 리포트, DAO 실험.</p></div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="wrap footline">
      <div class="muted">© 2025 Stance — LocalFlow Project .feat GPT</div>
      <div class="muted">LocalFlow는 시민 참여형 로컬 순환 실험입니다.</div>
    </div>
  </footer>

  <button id="toTop" class="to-top" aria-label="맨 위로">↑</button>

  <!-- Notice Modal -->
  <div id="noticeModal" class="notice-modal" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="dialog" aria-modal="true">
      <button class="modal-close" aria-label="닫기">×</button>
      <img id="modalImg" class="modal-img" src="" alt="" />
      <div class="modal-meta" id="modalDate"></div>
      <h3 class="modal-title" id="modalTitle"></h3>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div id="toast" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
  background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:.9rem;
  box-shadow:0 10px 24px rgba(0,0,0,.2);opacity:0;pointer-events:none;transition:opacity .2s;
  z-index:90">새 공지가 업데이트되었습니다</div>





  

 <script>  
const btn = document.getElementById('menuBtn');
const mobileMenu = document.getElementById('mobileMenu');
const ovl  = document.getElementById('overlay');

function openMenu(open) {
  if (open) {
    mobileMenu.classList.add('show');
    ovl.classList.add('show');
    btn.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';
  } else {
    mobileMenu.classList.remove('show');
    ovl.classList.remove('show');
    btn.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
  }
}

btn.addEventListener('click', () => {
  const willOpen = !mobileMenu.classList.contains('show');
  openMenu(willOpen);
});
ovl.addEventListener('click', () => openMenu(false));

// --- Floating words + data hybrid ---
const cloud = document.getElementById('cloud');
const input = document.getElementById('foodInput');
let cloudWidth = cloud.clientWidth;

const DATA_URL = "https://mrdindoin.ddns.net/data/latest-counts.json";

function todayKey(){ return new Date().toISOString().slice(0,10); }

function makeSizeScaler(items){
  const counts = items.map(i => Number(i.count) || 1);
  const min = Math.min(...counts);
  const max = Math.max(...counts);
  const span = max - min;

  const rankMap = new Map(items.map((it, i) => [it.food, i + 1]));
  const N = items.length || 1;

  return (count, food) => {
    if (span >= 1) {
      const t = (count - min) / span;
      return 14 + t * (28 - 14);
    } else {
      const r = rankMap.get(food) || N;
      const rt = (N - r) / Math.max(1, N - 1);
      const jitter = 0.9 + Math.random()*0.2;
      return (16 + rt * (30 - 16)) * jitter;
    }
  };
}

function spawn(arg1, arg2){
  let item = (typeof arg1 === 'object') ? arg1 : { food: String(arg1), count: 1, rank: 99 };
  const scale = (typeof arg2 === 'function') ? arg2 : null;

  const el = document.createElement('div');
  el.className = 'word';
  el.textContent = item.food;
  el.title = `${item.food} • ${item.count}`;

  const baseFs = 14 + Math.random()*14;
  const baseDur = 9 + Math.random()*8;

  const fs = scale ? scale(item.count, item.food) : baseFs;
  const dur = scale ? (9 + (28 - fs) * 0.4) : baseDur;

  const x = Math.max(8, Math.random()*(cloudWidth-80));
  const dx = (Math.random()*40 - 20) + "px";
  el.style.left = x+'px';
  el.style.bottom = '-20px';
  el.style.fontSize = fs+'px';
  el.style.animationDuration = dur+'s';
  el.style.setProperty('--dx', dx);
  if(item.rank === 1) el.style.fontWeight = '800';

  cloud.appendChild(el);
  setTimeout(()=> el.remove(), dur*1000);
}

async function loadWords(){
  const K_DATA="lf_words_v2", K_DATE="lf_date";
  const today = todayKey();

  try{
    if(localStorage.getItem(K_DATE) === today){
      const cached = JSON.parse(localStorage.getItem(K_DATA)||"[]");
      if(cached.length) return cached;
    }
  }catch{}

  try{
    const res = await fetch(DATA_URL, {cache:'no-store'});
    const data = await res.json();
    let items = Array.isArray(data.top) ? data.top.map((it,i)=>({
      food: String(it.food||'').trim(),
      count: Number(it.count)||1,
      rank: i+1
    })) : [];
    if(!items.length) throw new Error("empty top");
    localStorage.setItem(K_DATE, today);
    localStorage.setItem(K_DATA, JSON.stringify(items));
    return items;
  }catch{
    return ["치킨🍗","라멘🍜","곱창🔥","짜장면","비빔밥","피자🍕","탕수육🥢","막국수","삼겹살🐷","연어"]
      .map((n,i)=>({food:n,count:1,rank:i+1}));
  }
}

let WORDS=null, sizeScale=null;
async function initWords(){ WORDS = await loadWords(); sizeScale = makeSizeScaler(WORDS); }

async function seedLoop(){
  if(!WORDS) await initWords();
  const pick = WORDS[Math.floor(Math.random()*WORDS.length)];
  spawn(pick, sizeScale);
  setTimeout(seedLoop, 600 + Math.random()*900);
}
seedLoop();

function addWord(e){
  e.preventDefault();
  const v = (input.value||"").trim();
  if(!v) return false;
  spawn(v);
  fetch(`https://mrdindoin.ddns.net/event/?food=${encodeURIComponent(v)}`);
  if(userEmail) url += `&email=${encodeURIComponent(userEmail)}`;
  fetch(url);
  input.value=""; input.focus();
  return false;
}

   // --- Close menu on nav-link click + smooth scroll ---
    document.querySelectorAll('#mobileMenu a').forEach((a) => {
      a.addEventListener('click', (e) => {
        const href = a.getAttribute('href');
    
        if (href && href.startsWith('#')) {
          e.preventDefault();
          const target = document.querySelector(href);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }
    
        if (typeof openMenu === 'function') {
          openMenu(false);
        } else {
          const mobileMenu = document.getElementById('mobileMenu');
          const ovl = document.getElementById('overlay');
          const btn = document.getElementById('menuBtn');
          mobileMenu?.classList.remove('show');
          ovl?.classList.remove('show');
          btn?.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
      });
    });
    
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (typeof openMenu === 'function') openMenu(false);
        else {
          document.getElementById('mobileMenu')?.classList.remove('show');
          document.getElementById('overlay')?.classList.remove('show');
          document.getElementById('menuBtn')?.setAttribute('aria-expanded','false');
          document.body.style.overflow = '';
        }
      }
    });

window.addEventListener('resize', () => {
  if (window.innerWidth >= 860) {
    if (typeof openMenu === 'function') openMenu(false);
    else {
      document.getElementById('mobileMenu')?.classList.remove('show');
      document.getElementById('overlay')?.classList.remove('show');
      document.getElementById('menuBtn')?.setAttribute('aria-expanded','false');
      document.body.style.overflow = '';
    }
  }
});

    const NOTICE_URL = "https://mrdindoin.ddns.net/data/notices.json";
    const $feed = document.getElementById('noticeFeed');
    const $skeleton = document.getElementById('noticeSkeleton');
    const $more = document.getElementById('noticeMore');
    const PAGE_SIZE = 6;
    let _notices = [], _page = 0;
    
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}.${m}.${day}`;
      }catch{ return iso||''; }
    }
    
    function esc(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function nl2br(s){ return esc(s).replace(/\n/g, '<br>'); }
    
    function noticeItemHTML(n){
      const hasImg = !!n.image;
      return `
        <article class="card">
          <div class="notice-card">
            ${hasImg ? `<img class="notice-thumb" loading="lazy" src="${esc(n.image)}" alt="">` : `<div class="notice-thumb" aria-hidden="true" style="display:none"></div>`}
            <div>
              <div class="notice-meta">${fmtDate(n.date)}</div>
              <h3 class="notice-title">${esc(n.title)}</h3>
              <div class="notice-body">${nl2br(n.body)}</div>
            </div>
          </div>
        </article>
      `;
    }
    
    function renderPage(){
      const start = _page * PAGE_SIZE;
      const slice = _notices.slice(start, start + PAGE_SIZE);
      if(!slice.length){ $more.style.display = 'none'; return; }
      const html = slice.map(noticeItemHTML).join('');
      $feed.insertAdjacentHTML('beforeend', html);
      _page++;

      $more.style.display = (_page * PAGE_SIZE < _notices.length) ? 'inline-block' : 'none';
    }
    
    async function loadNotices(){
      try{
        $skeleton.style.display = 'grid';
        const res = await fetch(NOTICE_URL, {cache:'no-store', mode:'cors'});
        const data = await res.json();
    
        _notices = (Array.isArray(data) ? data : [])
          .map(n => ({
            title: n.title ?? '',
            body: n.body ?? '',
            date: n.date ?? '',
            image: n.image ?? ''
          }))
          .sort((a,b) => new Date(b.date) - new Date(a.date));
    
        $feed.innerHTML = '';
        _page = 0;
        renderPage();
      }catch(e){
        $feed.innerHTML = `<div class="card"><div class="muted">공지 데이터를 불러오지 못했습니다.</div></div>`;
        console.error('notices load error', e);
      }finally{
        $skeleton.style.display = 'none';
      }
    }
    
    $more.addEventListener('click', renderPage);
    loadNotices();

    // ===== Notice Modal =====
    const modal = document.getElementById('noticeModal');
    const modalImg = document.getElementById('modalImg');
    const modalDate = document.getElementById('modalDate');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.querySelector('.modal-close');
    
    function openModal(notice){
      modalImg.src = notice.image || '';
      modalImg.style.display = notice.image ? 'block' : 'none';
      modalDate.textContent = fmtDate(notice.date);
      modalTitle.textContent = notice.title;
      modalBody.innerHTML = nl2br(notice.body);
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal(){
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
    
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{
      if(e.target.classList.contains('modal-backdrop')) closeModal();
    });
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') closeModal();
    });
    
    function attachNoticeEvents(){
      $feed.querySelectorAll('.card').forEach((card, idx)=>{
        card.addEventListener('click', ()=>{
          const n = _notices[idx];
          if(n) openModal(n);
        });
      });
    }
    
    function renderPage(){
      const start = _page * PAGE_SIZE;
      const slice = _notices.slice(start, start + PAGE_SIZE);
      if(!slice.length){ $more.style.display = 'none'; return; }
      const html = slice.map(noticeItemHTML).join('');
      $feed.insertAdjacentHTML('beforeend', html);
      _page++;
      $more.style.display = (_page * PAGE_SIZE < _notices.length) ? 'inline-block' : 'none';
      attachNoticeEvents(); // << 추가
    }


   // ===== Auto Refresh for Notices =====
    const REFRESH_MS = 120000; // 2분마다 갱신 (원하면 300000=5분)
    let _sig = "";             // 데이터 시그니처(간단 해시)
    let _timer = null;
    
    function signatureOf(arr){
      // 최신 날짜 + 길이 + 앞 3개 제목을 묶어 간단 시그니처
      if(!Array.isArray(arr) || !arr.length) return "empty";
      const latest = arr
        .map(n => new Date(n.date).getTime() || 0)
        .reduce((a,b)=>Math.max(a,b), 0);
      const titles = arr.slice(0,3).map(n => n.title).join("|");
      return `${arr.length}-${latest}-${titles}`;
    }
    
    function toast(msg="새 공지가 업데이트되었습니다"){
      const t = document.getElementById('toast');
      if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    }
    
    async function refreshNotices(){
      try{
        // 새 데이터 가져오기
        const res = await fetch(NOTICE_URL, {cache:'no-store', mode:'cors'});
        const data = await res.json();
        const next = (Array.isArray(data) ? data : [])
          .map(n => ({ title:n.title??'', body:n.body??'', date:n.date??'', image:n.image??'' }))
          .sort((a,b)=> new Date(b.date) - new Date(a.date));
    
        const nextSig = signatureOf(next);
        if(nextSig !== _sig){
          // 갱신 발생 → 상태 교체 & 리렌더
          _notices = next;
          _sig = nextSig;
          $feed.innerHTML = '';
          _page = 0;
          renderPage();
          toast();
        }
      }catch(e){
        // 조용히 무시(네트워크 이슈 등), 연속 오류 시 백오프 원하면 여기서 처리
        // console.warn('refresh error', e);
      }
    }
    
    function startNoticeAutoRefresh(){
      // 초기 시그니처 설정
      _sig = signatureOf(_notices);
      stopNoticeAutoRefresh();
      _timer = setInterval(refreshNotices, REFRESH_MS);
    }
    
    function stopNoticeAutoRefresh(){
      if(_timer){ clearInterval(_timer); _timer = null; }
    }
    
    // 탭 비활성화 시 정지, 다시 활성화 시 즉시 갱신 + 타이머 재가동
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){ stopNoticeAutoRefresh(); }
      else { refreshNotices(); startNoticeAutoRefresh(); }
    });
    
    // 초기 로딩 직후 자동 갱신 시작
    // (loadNotices() 내부에서 renderPage()가 끝난 뒤 호출)
    const _origLoadNotices = loadNotices;
    loadNotices = async function(){
      await _origLoadNotices();
      startNoticeAutoRefresh();
    };
    
    // 페이지 첫 로딩 시 loadNotices가 이미 호출되었다면,
    // 아래 한 줄로도 시작 가능 (중복 시작 방지 위해 존재 체크)
    if(typeof _notices !== 'undefined' && _notices.length >= 0 && !_timer){
      startNoticeAutoRefresh();
    }


   // --- Email Handling ---
    let userEmail = null;
    const emailInput = document.getElementById('emailInput');
    const emailSubmit = document.getElementById('emailSubmit');
    const emailDisplay = document.getElementById('emailDisplay');
    const emailBtn = document.getElementById('emailBtn');
    
    emailSubmit.addEventListener('click', () => {
      const val = emailInput.value.trim();
      if (!val || !val.includes('@')) {
        alert('올바른 이메일을 입력하세요.');
        return;
      }
      userEmail = val;
      // 입력창 숨기기, 버튼 표시
      emailInput.style.display = 'none';
      emailSubmit.style.display = 'none';
      emailBtn.textContent = val;
      emailDisplay.style.display = 'block';
    });
    
    // 이메일 버튼 눌러 수정 모드로 전환
    emailBtn.addEventListener('click', () => {
      emailDisplay.style.display = 'none';
      emailInput.style.display = 'inline-block';
      emailSubmit.style.display = 'inline-block';
      emailInput.focus();
    });
   

   // --- Back to Top ---
  const toTop = document.getElementById('toTop');
  window.addEventListener('scroll', () => {
    const y = window.scrollY || document.documentElement.scrollTop;
    if (y > 300) toTop.classList.add('show');
    else toTop.classList.remove('show');
  });
  toTop.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

addEventListener('resize', ()=> { cloudWidth = cloud.clientWidth; });
</script>


  
</body>
</html>
