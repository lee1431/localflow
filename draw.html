<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LocalFlow â€” ì¶”ì²¨</title>
<meta name="theme-color" content="#61D6C2"/>
<style>
  :root{--bg:#0b0f14;--panel:#111826;--ink:#eaf2ff;--muted:#9fb0c7;--line:#1e2330;--accent:#61d6c2;--win:#22c55e;--lose:#ef4444;}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0a0f16,#070b11);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin:6px 0 16px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border:1px solid var(--line);border-radius:7px;display:grid;place-items:center;background:#0e1522;font-weight:800}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type="email"],input[type="text"]{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f172a;color:var(--ink)}
  .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1}
  button{appearance:none;border:1px solid var(--line);background:#0f172a;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  button:active{transform:translateY(1px)}
  .big{width:100%;padding:14px;font-size:16px;background:#122034}
  .muted{color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:14px 0}
  .wheel{height:120px;border:1px dashed #223049;border-radius:12px;display:grid;place-items:center;margin-top:10px;background:#0c121d}
  .spin{animation:spin .6s linear infinite}@keyframes spin{to{transform:rotate(1turn)}}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#0f172a;font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:.3rem .6rem;border:1px solid var(--line);border-radius:999px;background:#0f172a;color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
  .prize{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0e1624}
  .result{margin-top:10px;padding:12px;border-radius:12px;border:1px solid var(--line)}
  .result.win{border-color:#1d3a29;background:#0d1f16}
  .result.lose{border-color:#3a1d1d;background:#1a0e0e}
  marquee{margin-top:8px;color:var(--muted)}
</style>
</head>
<body>
  <main class="wrap">
    <header>
      <div class="brand">
        <div class="logo">LF</div>
        <div>
          <div style="font-weight:800">LocalFlow ì¶”ì²¨</div>
          <div class="muted" style="font-size:12px">ë§¤ì£¼ ì§€ì—­ìˆœí™˜ ì¿ í° ì´ë²¤íŠ¸</div>
        </div>
      </div>
      <div class="badge"><span>Î²</span><span>anti-bot & ì¬ê³  ì—°ë™</span></div>
    </header>

    <!-- ì‚¬ìš©ì ì •ë³´ -->
    <section class="card">
      <div class="row">
        <div>
          <label for="email">ì´ë©”ì¼</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
        </div>
        <div>
          <label for="name">ë‹‰ë„¤ì„(ì„ íƒ)</label>
          <input id="name" type="text" placeholder="ë³„ëª… ë˜ëŠ” ì´ë¦„"/>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button id="save" title="ë‹¤ìŒì—ë„ ìë™ ì…ë ¥">ì •ë³´ ì €ì¥</button>
        <button id="clear">ì§€ìš°ê¸°</button>
      </div>
    </section>

    <!-- ì¶”ì²¨ ë³¸ì²´ -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div class="badge"><span>ğŸŸ</span><span id="mode">ì—°ê²° í™•ì¸ ì¤‘â€¦</span></div>
        <button id="drawBtn" class="big">ì¶”ì²¨ ì‹œì‘</button>
      </div>
      <div id="wheel" class="wheel muted">ëŒ€ê¸° ì¤‘</div>
      <div id="result" class="result muted" style="display:none"></div>

      <marquee id="winnersMarq" behavior="scroll" direction="left" scrollamount="5">ìµœê·¼ ë‹¹ì²¨ì ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</marquee>
    </section>

    <!-- ì¬ê³ /ìƒí’ˆ ë¯¸ë¦¬ë³´ê¸° -->
    <section class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì´ë²ˆ íšŒì°¨ ìƒí’ˆ</strong>
        <span class="pill" id="roundLabel">íšŒì°¨ ì •ë³´</span>
      </div>
      <div id="prizeGrid" class="grid" style="margin-top:8px"></div>
    </section>

    <footer class="muted" style="text-align:center;margin:20px 0 30px">Â© LocalFlow</footer>
  </main>

<script>
/* ==== ì„¤ì • (ì—”ë“œí¬ì¸íŠ¸ëŠ” ìƒëŒ€ê²½ë¡œ ê¶Œì¥; CORS íšŒí”¼) ==== */
const API = {
  status:   "/event/status",   // GET  -> {ok:true, round:"2025-W45"} or 404
  draw:     "/event/draw",     // POST -> {ok:true, win:true, prize:{id,name}, ticket:"...", remain:{...}}
  winners:  "/data/winners.json", // GET -> ["2025-11-08 í™*ë™ ì»¤í”¼ì¿ í°","..."]
  prizes:   "/data/prizes.json"   // GET -> {round:"...", items:[{id,name,stock},{...}]}
};
/* ë¡œì»¬ëª¨ë“œ fallbackìš© ë”ë¯¸ ìƒí’ˆ */
const LOCAL_PRIZES = [
  {id:"coffee", name:"ì»¤í”¼ ì¿ í°", stock:3, weight:20},
  {id:"chicken", name:"ì¹˜í‚¨ ì¿ í°", stock:1, weight:5},
  {id:"gift", name:"ì§€ì—­ìƒí’ˆê¶Œ 1ë§Œì›", stock:2, weight:8},
  {id:"blank", name:"ê½", stock:999, weight:67}
];

const $ = sel => document.querySelector(sel);
const email = $("#email"), nameEl = $("#name");
const wheel = $("#wheel"), result = $("#result"), mode = $("#mode");
const prizeGrid = $("#prizeGrid"), roundLabel = $("#roundLabel"), marq = $("#winnersMarq");
$("#save").onclick = () => { localStorage.setItem("lf_email", email.value.trim()); localStorage.setItem("lf_name", nameEl.value.trim()); toast("ì €ì¥ ì™„ë£Œ"); };
$("#clear").onclick = () => { email.value=""; nameEl.value=""; localStorage.removeItem("lf_email"); localStorage.removeItem("lf_name"); };

function toast(t){ wheel.textContent = t; setTimeout(()=>{ wheel.textContent="ëŒ€ê¸° ì¤‘"; }, 1200); }
function setSpinning(on){ wheel.classList.toggle("spin", on); wheel.textContent = on ? "ì¶”ì²¨ ì¤‘â€¦" : "ëŒ€ê¸° ì¤‘"; }

/* ì´ˆê¸° ë¡œë“œ */
(function init(){
  email.value = localStorage.getItem("lf_email") || "";
  nameEl.value = localStorage.getItem("lf_name") || "";
  probeServer();
  loadPrizes();
  loadWinners();
})();

/* ì„œë²„ ëª¨ë“œ ê°ì§€ */
async function probeServer(){
  try{
    const r = await fetch(API.status, {cache:"no-store"});
    if(r.ok){
      const j = await r.json();
      mode.textContent = "ì„œë²„ ëª¨ë“œ(ì¬ê³ /ì¤‘ë³µê²€ì¦)";
      if(j.round) roundLabel.textContent = j.round;
      return true;
    }
  }catch(_){}
  mode.textContent = "ë¡œì»¬ ëª¨ë“œ(í…ŒìŠ¤íŠ¸)";
  return false;
}

/* ìƒí’ˆí‘œì‹œ */
async function loadPrizes(){
  prizeGrid.innerHTML = "";
  try{
    const r = await fetch(API.prizes, {cache:"no-store"});
    if(r.ok){
      const j = await r.json();
      if(j.round) roundLabel.textContent = j.round;
      (j.items||[]).forEach(p => addPrize(p));
      return;
    }
  }catch(_){}
  LOCAL_PRIZES.forEach(p => addPrize(p));
}
function addPrize(p){
  prizeGrid.insertAdjacentHTML("beforeend",
    `<div class="prize"><div style="font-weight:700">${p.name}</div><div class="muted" style="font-size:12px">ì¬ê³  ${p.stock??"-"}</div></div>`);
}

/* ìµœê·¼ ë‹¹ì²¨ì */
async function loadWinners(){
  try{
    const r = await fetch(API.winners, {cache:"no-store"});
    const arr = r.ok ? await r.json() : [];
    marq.textContent = arr.length ? arr.join("  â€¢  ") : "ì•„ì§ ë‹¹ì²¨ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
  }catch(_){
    marq.textContent = "ë¡œì»¬ ëª¨ë“œ â€” ë‹¹ì²¨ ë‚´ì—­ ì—†ìŒ";
  }
}

/* ì¶”ì²¨ ë²„íŠ¼ */
$("#drawBtn").onclick = async ()=>{
  const mail = (email.value||"").trim();
  if(!mail || !/^[^@]+@[^@]+\.[^@]+$/.test(mail)){ alert("ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

  setSpinning(true); result.style.display="none";
  const serverOk = await probeServer();

  if(serverOk){
    /* --- ì„œë²„ ëª¨ë“œ: ì„œë²„ê°€ ê²°ê³¼ë¥¼ ê²°ì •(ê¶Œì¥) --- */
    try{
      const r = await fetch(API.draw, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ email: mail, name: nameEl.value||"", ua:navigator.userAgent })
      });
      const j = await r.json();
      showResult(j.ok && j.win, j.prize?.name || "ê½", j.msg);
      if(j.remain) refreshRemain(j.remain);
    }catch(e){
      showResult(false, "í†µì‹  ì˜¤ë¥˜", "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    } finally { setSpinning(false); }
  } else {
    /* --- ë¡œì»¬ ëª¨ë“œ: ì„ì‹œ ê°€ì¤‘ì¹˜ ì¶”ì²¨(í…ŒìŠ¤íŠ¸ìš©) --- */
    const prize = weightedPick(LOCAL_PRIZES);
    const win = prize.id !== "blank";
    setTimeout(()=>{
      showResult(win, prize.name);
      setSpinning(false);
    }, 600);
  }
};

function weightedPick(items){
  const pool = []; items.forEach(i=>{ for(let k=0;k<(i.weight||1);k++) pool.push(i); });
  return pool[Math.floor(Math.random()*pool.length)];
}
function showResult(win, label, extra){
  result.className = "result " + (win?"win":"lose");
  result.style.display="block";
  result.innerHTML = win
    ? `âœ… ì¶•í•˜í•©ë‹ˆë‹¤! <strong>${label}</strong> ë‹¹ì²¨ì…ë‹ˆë‹¤.${extra?`<div class="muted">${extra}</div>`:""}`
    : `ğŸ™‡â€â™‚ï¸ ì•„ì‰½ìŠµë‹ˆë‹¤â€¦ <strong>${label}</strong>.${extra?`<div class="muted">${extra}</div>`:""}`;
}
function refreshRemain(remain){
  // remain: {coffee:2, ...} í˜•ì‹ ê°€ì •. í•„ìš” ì‹œ /data/prizes.json ì¬ìš”ì²­ìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥
  loadPrizes();
}
</script>
</body>
</html>
