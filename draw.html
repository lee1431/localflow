<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>LocalFlow â€” ì¶”ì²¨</title>
<meta name="theme-color" content="#61D6C2" />
<meta name="description" content="LocalFlow ì£¼ê°„ ìˆœí™˜ ì¿ í° ì¶”ì²¨" />

<style>
  :root{
    --bg:#0b0f14; --panel:#111826; --ink:#eaf2ff; --muted:#9fb0c7; --line:#1e2330; --accent:#61d6c2;
    --pill:#0f172a; --thumb:#0c121d;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f16,#070b11);color:var(--ink);
       font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1080px;margin:0 auto;padding:14px}

  /* Header (LocalFlow ìŠ¤íƒ€ì¼) */
  header{position:sticky;top:0;background:rgba(7,11,17,.85);backdrop-filter:saturate(150%) blur(6px);
         border-bottom:1px solid var(--line);z-index:10}
  .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:26px;height:26px;border:1px solid var(--line);border-radius:7px;display:grid;place-items:center;
        background:#0e1522;font-weight:800}
  .badge{font-size:10px;padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#0f1624;color:var(--muted)}

  /* Common UI */
  .pill{display:inline-block;padding:.32rem .65rem;border:1px solid var(--line);border-radius:999px;background:var(--pill);color:var(--muted);font-size:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .cols-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .muted{color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .btn{appearance:none;border:1px solid var(--line);background:#0f172a;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}

  /* Hero */
  .hero{padding:24px 0 10px;border-bottom:1px solid var(--line)}
  h1{margin:6px 0 8px;font-size:clamp(22px,4vw,28px)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="email"],input[type="text"]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f172a;color:var(--ink)}

  /* Main sections */
  .wheel{height:140px;border:1px dashed #223049;border-radius:12px;display:grid;place-items:center;margin-top:10px;background:var(--thumb);color:var(--muted)}
  .spin{animation:spin .65s linear infinite}@keyframes spin{to{transform:rotate(1turn)}}
  .result{margin-top:10px;padding:12px;border-radius:12px;border:1px solid var(--line)}
  .result.win{border-color:#1d3a29;background:#0d1f16}
  .result.lose{border-color:#3a1d1d;background:#1a0e0e}
  .prize{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0e1624}
  .prize .name{font-weight:700}
  .prize .stock{font-size:12px;color:var(--muted)}
  .cta{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .primary{padding:12px 16px;background:#122034}
  marquee{margin-top:8px;color:var(--muted)}

  /* Footer */
  footer{margin:26px 0 36px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>

<header>
  <div class="wrap nav">
    <div class="brand">
      <div class="logo">LF</div>
      <div>LocalFlow <small class="muted">â€” ì¶”ì²¨</small></div>
      <span class="badge">beta</span>
    </div>
    <a class="pill" href="/" title="ë©”ì¸ìœ¼ë¡œ">â† LocalFlow</a>
  </div>
</header>

<main class="wrap">
  <!-- Hero -->
  <section class="hero">
    <span class="pill">ì‹œë¯¼ ì°¸ì—¬í˜• ë¡œì»¬ ìˆœí™˜ í”„ë¡œì íŠ¸</span>
    <h1>ì´ë²ˆ ì£¼ ì¶”ì²¨</h1>
    <p class="muted" style="margin:0">ì´ë©”ì¼ì€ ë‹¹ì²¨ í™•ì¸ ë° ìƒí’ˆ ë°œì†¡ì—ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
    <div class="row" style="margin-top:10px">
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email" style="min-width:240px">
      <input id="name" type="text" placeholder="ë‹‰ë„¤ì„(ì„ íƒ)">
      <button id="save" class="btn">ì •ë³´ ì €ì¥</button>
      <button id="clear" class="btn">ì§€ìš°ê¸°</button>
    </div>
  </section>

  <!-- ì¶”ì²¨ ë³¸ì²´ -->
  <section class="grid cols-2" style="margin-top:14px">
    <div class="card">
      <div class="cta">
        <span class="pill" id="mode">ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
        <button id="drawBtn" class="btn primary">ì¶”ì²¨ ì‹œì‘</button>
      </div>
      <div id="wheel" class="wheel">ëŒ€ê¸° ì¤‘</div>
      <div id="result" class="result" style="display:none"></div>
      <marquee id="marq">ìµœê·¼ ë‹¹ì²¨ì ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</marquee>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>ì´ë²ˆ íšŒì°¨ ìƒí’ˆ</strong>
        <span class="pill" id="roundLabel">íšŒì°¨ ì •ë³´</span>
      </div>
      <div id="prizeGrid" class="grid cols-3" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- ì•ˆë‚´ -->
  <section class="card" style="margin-top:12px">
    <div class="grid cols-3">
      <div><div class="pill">â‘  ì…ë ¥</div><p style="margin:8px 0 0" class="muted">ì´ë©”ì¼/ë‹‰ë„¤ì„ì„ ì ê³  ì¶”ì²¨ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p></div>
      <div><div class="pill">â‘¡ ì¶”ì²¨</div><p style="margin:8px 0 0" class="muted">ì„œë²„ ì¬ê³ /ì¤‘ë³µê²€ì¦ì„ í†µê³¼í•˜ë©´ ì¦‰ì‹œ ê²°ê³¼ ì•ˆë‚´.</p></div>
      <div><div class="pill">â‘¢ ìˆ˜ë ¹</div><p style="margin:8px 0 0" class="muted">ë‹¹ì²¨ìëŠ” ì´ë©”ì¼ë¡œ ì „ë‹¬ëœ ì•ˆë‚´ì— ë”°ë¼ ìˆ˜ë ¹í•©ë‹ˆë‹¤.</p></div>
    </div>
  </section>

  <footer>Â© 2025 Stance â€” LocalFlow Project</footer>
</main>

<script>
/* ====== API (ë™ì¼ ì˜¤ë¦¬ì§„ ìƒëŒ€ê²½ë¡œ: CORS ë¬´ê´€) ====== */
const API = {
  status:  "/event/status",       // GET -> { ok:true, round:"2025-W45" }
  draw:    "/event/draw",         // POST -> { ok:true, win:true|false, prize:{id,name}? , remain?... }
  winners: "/data/winners.json",  // GET -> ["2025-11-08 í™*ë™ ì»¤í”¼ì¿ í°", ...]
  prizes:  "/data/prizes.json"    // GET -> { round:"...", items:[{id,name,stock}, ...] }
};

const $ = s=>document.querySelector(s);
const email=$("#email"), nameEl=$("#name"), wheel=$("#wheel"), result=$("#result");
const mode=$("#mode"), marq=$("#marq"), prizeGrid=$("#prizeGrid"), roundLabel=$("#roundLabel");

$("#save").onclick = ()=>{ localStorage.setItem("lf_email",email.value.trim()); localStorage.setItem("lf_name",nameEl.value.trim()); toast("ì €ì¥ ì™„ë£Œ"); };
$("#clear").onclick= ()=>{ email.value=""; nameEl.value=""; localStorage.removeItem("lf_email"); localStorage.removeItem("lf_name"); };

(function init(){
  email.value = localStorage.getItem("lf_email")||"";
  nameEl.value= localStorage.getItem("lf_name")||"";
  probeServer(); loadPrizes(); loadWinners();
})();

function toast(t){ wheel.textContent=t; setTimeout(()=>wheel.textContent="ëŒ€ê¸° ì¤‘",1200); }
function setSpin(on){ wheel.classList.toggle("spin",on); wheel.textContent=on?"ì¶”ì²¨ ì¤‘â€¦":"ëŒ€ê¸° ì¤‘"; }

/* ì„œë²„ ëª¨ë“œ í™•ì¸ */
async function probeServer(){
  try{
    const r = await fetch(API.status,{cache:"no-store"});
    if(r.ok){ const j=await r.json(); mode.textContent="ì„œë²„ ëª¨ë“œ(ì¬ê³ /ì¤‘ë³µê²€ì¦)"; if(j.round) roundLabel.textContent=j.round; return true; }
  }catch(e){}
  mode.textContent="ë¡œì»¬ ëª¨ë“œ(í…ŒìŠ¤íŠ¸)"; return false;
}

/* ìƒí’ˆ ë¡œë“œ */
async function loadPrizes(){
  prizeGrid.innerHTML="";
  try{
    const r = await fetch(API.prizes,{cache:"no-store"});
    if(r.ok){
      const j = await r.json();
      if(j.round) roundLabel.textContent=j.round;
      (j.items||[]).forEach(p=>addPrize(p));
      return;
    }
  }catch(e){}
  // ë¡œì»¬ í”„ë¦¬ì…‹
  [{id:"coffee",name:"ì»¤í”¼ ì¿ í°",stock:3},{id:"chicken",name:"ì¹˜í‚¨ ì¿ í°",stock:1},{id:"gift",name:"ì§€ì—­ìƒí’ˆê¶Œ 1ë§Œì›",stock:2},{id:"blank",name:"ê½",stock:"â€“"}]
    .forEach(p=>addPrize(p));
}
function addPrize(p){
  prizeGrid.insertAdjacentHTML("beforeend",
    `<div class="prize"><div class="name">${p.name}</div><div class="stock">ì¬ê³  ${p.stock}</div></div>`);
}

/* ìµœê·¼ ë‹¹ì²¨ì */
async function loadWinners(){
  try{
    const r = await fetch(API.winners,{cache:"no-store"});
    const arr = r.ok ? await r.json() : [];
    marq.textContent = arr.length ? arr.join("  â€¢  ") : "ì•„ì§ ë‹¹ì²¨ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
  }catch(e){ marq.textContent="ë¡œì»¬ ëª¨ë“œ â€” ë‹¹ì²¨ ë‚´ì—­ ì—†ìŒ"; }
}

/* ì¶”ì²¨ */
$("#drawBtn").onclick = async ()=>{
  const mail=(email.value||"").trim();
  if(!mail || !/^[^@]+@[^@]+\.[^@]+$/.test(mail)){ alert("ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  setSpin(true); result.style.display="none";
  const serverOk = await probeServer();

  if(serverOk){
    try{
      const r = await fetch(API.draw,{method:"POST",headers:{"Content-Type":"application/json"},
                   body:JSON.stringify({email:mail,name:nameEl.value||"",ua:navigator.userAgent})});
      const j = await r.json();
      showResult(j.ok && j.win, j.prize?.name || "ê½", j.msg);
      if(j.remain){ loadPrizes(); }
    }catch(e){ showResult(false,"í†µì‹  ì˜¤ë¥˜","ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); }
    finally{ setSpin(false); }
  }else{
    // ë¡œì»¬ í…ŒìŠ¤íŠ¸ ëœë¤
    const tmp=[{name:"ì»¤í”¼ ì¿ í°",w:20},{name:"ì¹˜í‚¨ ì¿ í°",w:5},{name:"ì§€ì—­ìƒí’ˆê¶Œ 1ë§Œì›",w:8},{name:"ê½",w:67}];
    const pick = weightedPick(tmp);
    setTimeout(()=>{ showResult(pick!=="ê½", pick); setSpin(false); }, 600);
  }
};
function weightedPick(arr){
  const pool=[]; arr.forEach(i=>{ for(let k=0;k<(i.w||1);k++) pool.push(i.name); });
  return pool[Math.floor(Math.random()*pool.length)];
}
function showResult(win,label,extra){
  result.className="result "+(win?"win":"lose");
  result.style.display="block";
  result.innerHTML = win
    ? `âœ… ì¶•í•˜í•©ë‹ˆë‹¤! <strong>${label}</strong> ë‹¹ì²¨ì…ë‹ˆë‹¤.${extra?`<div class="muted">${extra}</div>`:""}`
    : `ğŸ™‡â€â™‚ï¸ ì•„ì‰½ìŠµë‹ˆë‹¤â€¦ <strong>${label}</strong>.${extra?`<div class="muted">${extra}</div>`:""}`;
}
</script>
</body>
</html>
